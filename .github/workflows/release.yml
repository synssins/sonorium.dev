name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.1.0-alpha, v1.0.0, etc.

permissions:
  contents: write  # Required for creating releases

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Determine source branch
        id: branch
        run: |
          # Alpha/beta builds come from dev, stable builds come from main
          if [[ "${{ github.ref }}" == *"alpha"* ]] || [[ "${{ github.ref }}" == *"beta"* ]]; then
            echo "SOURCE_BRANCH=dev" >> $GITHUB_OUTPUT
            echo "Building alpha/beta release from dev branch"
          else
            echo "SOURCE_BRANCH=main" >> $GITHUB_OUTPUT
            echo "Building stable release from main branch"
          fi
        shell: bash

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.SOURCE_BRANCH }}
          fetch-depth: 0  # Fetch all history for tags

      - name: Fetch tag annotations
        run: git fetch --tags --force
        shell: bash

      - name: Verify branch
        run: |
          echo "Building from branch: ${{ steps.branch.outputs.SOURCE_BRANCH }}"
          echo "Current HEAD: $(git rev-parse HEAD)"
          echo "Tag: ${{ github.ref }}"
        shell: bash

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyQt6 pyinstaller pillow

      - name: Create icon.ico from PNG
        run: |
          python -c "from PIL import Image; img = Image.open('app/core/icon.png'); img.save('app/core/icon.ico', format='ICO', sizes=[(16,16), (32,32), (48,48), (64,64), (128,128), (256,256)])"

      - name: Build Sonorium.exe
        run: |
          cd app/windows/src
          pyinstaller --distpath .. --workpath ../build --clean Sonorium.spec

      - name: Build updater.exe
        run: |
          cd app/windows/src
          pyinstaller --distpath .. --workpath ../build --clean Updater.spec

      - name: Download Python embeddable
        run: |
          # Download Python 3.11 embeddable package (64-bit)
          $pythonUrl = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          $pipUrl = "https://bootstrap.pypa.io/get-pip.py"

          # Create python directory
          New-Item -ItemType Directory -Force -Path "python_embed"

          # Download and extract Python embeddable
          Write-Host "Downloading Python embeddable..."
          Invoke-WebRequest -Uri $pythonUrl -OutFile "python_embed.zip"
          Expand-Archive -Path "python_embed.zip" -DestinationPath "python_embed" -Force
          Remove-Item "python_embed.zip"

          # Enable pip by modifying python311._pth
          Write-Host "Enabling pip in embedded Python..."
          $pthFile = "python_embed/python311._pth"
          $pthContent = Get-Content $pthFile
          # Uncomment import site line and add Lib\site-packages
          $newContent = $pthContent -replace '#import site', 'import site'
          $newContent += "`nLib\site-packages"
          Set-Content -Path $pthFile -Value $newContent

          # Download and run get-pip.py
          Write-Host "Installing pip..."
          Invoke-WebRequest -Uri $pipUrl -OutFile "python_embed/get-pip.py"
          & "python_embed/python.exe" "python_embed/get-pip.py" --no-warn-script-location
          Remove-Item "python_embed/get-pip.py"
        shell: pwsh

      - name: Install core dependencies into embedded Python
        run: |
          Write-Host "Installing core dependencies..."

          # Install all dependencies from requirements.txt
          & "python_embed/python.exe" -m pip install --no-warn-script-location -r app/core/requirements.txt

          # Verify pyatv is installed
          Write-Host "Verifying pyatv installation..."
          & "python_embed/python.exe" -c "import pyatv; print(f'pyatv version: {pyatv.__version__}')"

          # List installed packages
          Write-Host "Installed packages:"
          & "python_embed/python.exe" -m pip list
        shell: pwsh

      - name: Create core.zip with embedded Python
        run: |
          # Create the zip with:
          # - core/ (source code)
          # - themes/ (audio themes)
          # - python/ (embedded Python with all dependencies)

          # Rename python_embed to python (what the launcher expects)
          Rename-Item -Path "python_embed" -NewName "python"

          # Create zip with all three folders
          Compress-Archive -Path "app/core", "app/themes", "python" -DestinationPath core.zip -Force

          # Show zip contents summary
          Write-Host "core.zip created with embedded Python"
          $zipSize = (Get-Item "core.zip").Length / 1MB
          Write-Host "Size: $([math]::Round($zipSize, 2)) MB"
        shell: pwsh

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Get tag message (changelog)
        id: get_changelog
        run: |
          # Get the annotated tag message (changelog)
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${GITHUB_REF#refs/tags/})
          # Use delimiter for multiline output
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Sonorium ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
          files: |
            app/windows/Sonorium.exe
            app/windows/updater.exe
            core.zip
          body: |
            ${{ steps.get_changelog.outputs.CHANGELOG }}

            ---

            ### Downloads
            - **Sonorium.exe** - Standalone Windows launcher (portable, ~37 MB)
            - **core.zip** - Core files with embedded Python (~100+ MB)

            ### First-time setup
            1. Download `Sonorium.exe` to any folder
            2. Run it - the app will automatically download required files
            3. No Python installation required - everything is self-contained!

            ### Manual installation
            1. Download both files
            2. Extract `core.zip` to the same folder as `Sonorium.exe`
            3. Run `Sonorium.exe`

            ### What's included
            - Embedded Python 3.11 runtime
            - All dependencies pre-installed (FastAPI, pyatv, etc.)
            - AirPlay, DLNA, Chromecast, and Sonos speaker support
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
